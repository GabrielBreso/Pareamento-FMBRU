<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>PAREAMENTO DOS BIXOS FMBRU</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            font-weight: 100;
        }

        header {
            padding: 3rem;
            background-color: #4CAF50;
            color: #fffdfd;
            text-align: center;
        }

        main {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 0;
        }

        main::before {
            content: '';
            position: absolute;
            padding: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.07;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }

        footer {
            background-color: #4CAF50;
            color: white;
            text-align: end;
            padding: 0;
            margin: 0;
            width: 100%;
            position: 0;
            bottom: 0;
        }

        div, details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 3rem;
        }

        h4 {
            font-weight: 100;
        }

        p {
            padding: 0.5rem;
            ;
        }
        
        a {
            color: #1d591f;
        }
        
        form {
            background-color: white;
            padding: 1rem;
            margin-left: 5rem;
            margin-right: 18rem;
            border-radius: 7px;
            text-align: left;
            box-shadow: 0 0 10px #1d591f;
        }

        input[type=file] {
            display: block;
            margin-bottom: 20px;
        }

        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 75%;
            border-collapse: collapse;
            border-radius: 5px;
            margin-top: 2rem;
            margin-left: 5rem;
            margin-right: 18rem;
            box-shadow: 0 0 10px #1d591f;
        }

        table,
        th,
        td {
            border: 1px solid #1d591f;
        }

        th,
        td {
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #4CAF50;
        }
    </style>
</head>

<body>
    <header>
        <h1>PAREAMENTO DOS BIXOS FMBRU</h1>
    </header>
    <main>
        <div style="padding-bottom: 0;">
            <form id="upload-form">
                <label for="tabela1">Formulário dos veteranos:</label>
                <input type="file" id="tabela1" name="tabela1" accept=".csv" required>
                <label for="tabela2">Formulário dos bixos:</label>
                <input type="file" id="tabela2" name="tabela2" accept=".csv" required>
                <label for="tabela2">Planilha de pesos:</label>
                <input type="file" id="tabelaPesos" name="tabelaPesos" accept=".csv" required>
                <input type="submit" value="PAREAR">
            </form>
            <div id="resultados"></div>
        </div>
    </main>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
        <script>
            document.getElementById('upload-form').addEventListener('submit', function (event) {
                event.preventDefault(); 
                const tabela1 = document.getElementById('tabela1').files[0];
                const tabela2 = document.getElementById('tabela2').files[0];
                const tabelaPesos = document.getElementById('tabelaPesos').files[0];

                if (!tabela1 || !tabela2 || !tabelaPesos) {
                    alert("Por favor, selecione todos os arquivos .csv.");
                    return;
                }
                    
                // Executa a função parseCSV (aquela que é capaz de traduzir os arquivos .csv em arrays para o código) para todas as variaveis, garantindo que o código só continua a funcionar se tudo correr bem com as 3 variaveis e desempacota os dados lidos pela função parseCSV e coloca os dados em formato de array dentro de cada parametro "data"
                // Em outras palavras transforma os dados dos arquivos .csv em arrays nos parametros data
                Promise.all([parseCSV(tabela1), parseCSV(tabela2), parseCSV(tabelaPesos)]).then(([data1, data2, dataPesos]) => {

                    if (data1.length === 0 || data2.length === 0 || dataPesos.length === 0) {
                        alert("Um dos arquivos .csv está vazio ou não pôde ser lido.");
                        return;
                    }
                    
                    if (!data1[0].hasOwnProperty('Nome completo') || !data2[0].hasOwnProperty('Nome completo')) {
                        alert("Um dos arquivos .csv não contém a coluna 'Nome completo'.");
                        return;
                    }
                    
                    conferirPesos(dataPesos);

                    //cria a variável resultados que vai ter seu valor igual ao return da função compararTabelas
                    const resultados = compararTabelas(data1, data2, dataPesos[0]);
                    
                    exibirResultados(resultados);
                    
                    salvarResultadosPDF(resultados, data1, data2);
                    
                    // Marca as pessoas não pareadas
                    if (resultados.length > 0) {
                        marcarNaoPareados(data1, data2, resultados);
                    }
                });
            }); 
            
            function parseCSV(file) {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: true, // Interpreta a primeira linha como cabeçalho
                        complete: results => resolve(results.data), // Retorna os dados do arquivo
                        error: err => reject(err) // Retorna o erro em caso de falha
                    });
                });
            }

            function conferirPesos(pesos){
                for (let i = 0; i < pesos.length; i++) {
                    if (isNaN(pesos[i]) || pesos[i] === "" || pesos[i] === null) {
                        alert(`Erro: O peso da questão ${i + 1} está ausente ou inválido.`);
                        return;
                    }
                }
            }

            function compararTabelas(tabela1, tabela2, pesos) {
                const resultados = [];
            
                const pesosArray = Object.values(pesos);

                // Verifica se todas as pessoas têm o mesmo número de respostas que os pesos
                for (const pessoa1 of tabela1) {
                    const respostas1 = extrairRespostasEscala(pessoa1);
                    if (respostas1.length !== pesosArray.length) {
                        alert("Erro: O número de questões do formulário dos veteranos e da planilha de pesos é diferente. Revise ambos os arquivos.");
                        return;
                    }
                }

                for (const pessoa2 of tabela2) {
                    const respostas2 = extrairRespostasEscala(pessoa2);
                    if (respostas2.length !== pesosArray.length) {
                        alert("Erro: O número de questões do formulário dos bixos e da planilha de pesos é diferente. Revise ambos os arquivos.");
                        return; 
                    }
                }

                // Itera sobre cada pessoa da tabela 1
                tabela1.forEach(pessoa1 => {
                    if (!pessoa1['Pareado']) {
                        // Itera sobre cada pessoa da tabela 2
                        tabela2.forEach(pessoa2 => {
                            if (!pessoa2['Pareado']) {
                                const respostas1 = extrairRespostasEscala(pessoa1);
                                const respostas2 = extrairRespostasEscala(pessoa2);
                                const distancia = calcularDistanciaEuclidianaComPesos(respostas1, respostas2, Object.values(pesos));

                                // Adiciona o resultado ao array de resultados
                                resultados.push({
                                    pessoaTabela1: pessoa1['Nome completo'],
                                    telefoneVeterano: String(pessoa1['Número do celular']),
                                    pessoaTabela2: pessoa2['Nome completo'],
                                    distancia: distancia,
                                    telefoneBixo: String(pessoa2['Número do celular']),
                                    horario1: new Date(pessoa1['Carimbo de data/hora']),
                                    horario2: new Date(pessoa2['Carimbo de data/hora'])
                                });
                            }
                        });
                    }
                });
                
                // Ordena os resultados por distância e, em caso de empate, pela data de resposta
                resultados.sort((a, b) => {
                    if (a.distancia === b.distancia) {
                        return a.horario2 - b.horario2; // Critério secundário
                    }
                    return a.distancia - b.distancia; // Critério principal
                });
                
                // Seleciona os melhores pares sem repetir pessoas
                const melhoresResultados = [];
                const usadosTabela1 = new Set();
                const usadosTabela2 = new Set();
                for (const resultado of resultados) {
                    if (!usadosTabela1.has(resultado.pessoaTabela1) && !usadosTabela2.has(resultado.pessoaTabela2)) {
                        melhoresResultados.push(resultado);
                        usadosTabela1.add(resultado.pessoaTabela1);
                        usadosTabela2.add(resultado.pessoaTabela2);
                    }
                }
                
                return melhoresResultados;
            }
            
            function extrairRespostasEscala(pessoa) {
                return Object.keys(pessoa)
                    .filter(key => {
                        const valor = parseInt(pessoa[key]);
                        return !isNaN(valor) && valor >= 1 && valor <= 3; // Verifica se o valor é válido
                    })
                    .map(key => pessoa[key]); // Retorna as respostas
            }
                
            function calcularDistanciaEuclidianaComPesos(respostas1, respostas2, pesos) {
                const somaQuadradosPonderados = respostas1.reduce((acc, val, index) => {
                    const diferenca = parseInt(val) - parseInt(respostas2[index]);
                    const quadradoPonderado = pesos[index] * (diferenca * diferenca);
                    return acc + quadradoPonderado;
                }, 0);

                return Math.sqrt(somaQuadradosPonderados);
            }

            function exibirResultados(resultados) {
                const resultadosDiv = document.getElementById('resultados');
                resultadosDiv.innerHTML = '';
                
                if (resultados.length === 0) {
                    resultadosDiv.textContent = "Nenhum resultado encontrado.";
                    return;
                }
                
                // Cria uma tabela para exibir os resultados
                const tabela = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                
                // Define o cabeçalho da tabela
                const cabecalho = ['Veteranos', 'Bixos', 'Distância', 'Telefone do Veterano', 'Telefone do Bixo'];
                const tr = document.createElement('tr');
                cabecalho.forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    tr.appendChild(th);
                });
                thead.appendChild(tr);
                tabela.appendChild(thead);
                
                // Preenche a tabela com os resultados
                resultados.forEach(resultado => {
                    const tr = document.createElement('tr');
                    ['pessoaTabela1', 'pessoaTabela2', 'distancia', 'telefoneVeterano', 'telefoneBixo'].forEach(key => {
                        const td = document.createElement('td');
                        if (key === 'distancia') {
                            td.textContent = parseFloat(resultado[key]).toFixed(5); // Formata para 5 casas decimais
                        } else {
                            td.textContent = resultado[key] || " ";
                        }
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                
                tabela.appendChild(tbody);
                resultadosDiv.appendChild(tabela);
            }
             
            function salvarResultadosPDF(resultados, tabela1, tabela2) {
                const { jsPDF } = window.jspdf;
                
                // Cria o primeiro PDF com as informações principais
                const doc1 = new jsPDF();
                const dadosTabela = resultados.map(resultado => [
                    resultado.pessoaTabela1,
                    resultado.pessoaTabela2,
                    resultado.distancia.toFixed(5),
                    resultado.telefoneVeterano,
                    resultado.telefoneBixo
                ]);
                
                doc1.autoTable({
                    head: [['Veteranos', 'Bixos', 'Distância', 'Telefone do Veterano', 'Telefone do Bixo']],
                    body: dadosTabela,
                    theme: 'striped',
                    headStyles: { fillColor: [34, 139, 34], textColor: [255, 255, 255] },
                    styles: { fillColor: false, textColor: [0, 0, 0] }
                });
                
                // Adiciona uma tabela com os não pareados
                const naoPareadosTabela1 = tabela1.filter(p => !resultados.some(r => r.pessoaTabela1 === p['Nome completo'])).map(p => [p['Nome completo'], 'Veterano']);
                const naoPareadosTabela2 = tabela2.filter(p => !resultados.some(r => r.pessoaTabela2 === p['Nome completo'])).map(p => [p['Nome completo'], 'Bixo']);
                
                if (naoPareadosTabela1.length > 0 || naoPareadosTabela2.length > 0) {
                    doc1.autoTable({
                        head: [['Não Pareados', 'Categoria']],
                        body: [...naoPareadosTabela1, ...naoPareadosTabela2],
                        startY: doc1.autoTable.previous.finalY + 10,
                        theme: 'striped',
                        headStyles: { fillColor: [231, 76, 60], textColor: [255, 255, 255] },
                        styles: { fillColor: false, textColor: [0, 0, 0] }
                    });
                }
                
                doc1.save('resultados_pareamento.pdf');
                
                // Cria o segundo PDF com menos informações (sem distância)
                const doc2 = new jsPDF();
                const dadosTabela2 = resultados.map(resultado => [
                    resultado.pessoaTabela1,
                    resultado.pessoaTabela2,
                    resultado.telefoneVeterano,
                    resultado.telefoneBixo,
                ]);
                
                doc2.autoTable({
                    head: [['Veteranos', 'Bixos', 'Telefone do Veterano', 'Telefone do Bixo']],
                    body: dadosTabela2,
                    theme: 'striped',
                    headStyles: { fillColor: [34, 139, 34], textColor: [255, 255, 255] },
                    styles: { fillColor: false, textColor: [0, 0, 0] }
                });
                
                if (naoPareadosTabela1.length > 0 || naoPareadosTabela2.length > 0) {
                    doc2.autoTable({
                        head: [['Não Pareados', 'Categoria']],
                        body: [...naoPareadosTabela1, ...naoPareadosTabela2],
                        startY: doc2.autoTable.previous.finalY + 10,
                        theme: 'striped',
                        headStyles: { fillColor: [231, 76, 60], textColor: [255, 255, 255] },
                        styles: { fillColor: false, textColor: [0, 0, 0] }
                    });
                }
                
                doc2.save('resultados_pareamento_sem_distancia.pdf');
            }

            function marcarNaoPareados(tabela1, tabela2, resultados) {
                tabela1.forEach(pessoa => {
                    if (!resultados.some(r => r.pessoaTabela1 === pessoa['Nome completo'])) {
                        pessoa['Pareado'] = 'Nao';
                    }
                });
                
                tabela2.forEach(pessoa => {
                    if (!resultados.some(r => r.pessoaTabela2 === pessoa['Nome completo'])) {
                        pessoa['Pareado'] = 'Nao';
                    }
                });
            }

        </script>     
</body>

</html>
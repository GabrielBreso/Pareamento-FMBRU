<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta name="google-site-verification" content="pBl1tFgu8FEUjr_fE-3on9zAahafnQTGmBrOYf45R9g" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAREAMENTO DOS BIXOS FMBRU</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Paleta de Cores Aprimorada baseada no original */
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #1d591f;
            --primary-light: #e8f5e9;
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Reset e Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Background sutil */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/b/b8/Logo_FMBRU.jpg') center/85% no-repeat;
            opacity: 0.05;
            z-index: -1;
            pointer-events: none;
        }

        /* Cabeçalho */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            text-align: center;
            padding: 4rem 1rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2.5rem !important; /* Sobrescrevendo o inline se necessário */
            font-weight: 800;
            letter-spacing: -0.025em;
            margin-bottom: 0.75rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Layout Principal */
        main {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1.5rem 4rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Cartões */
        div, details {
            background-color: var(--white);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        /* Títulos e Textos */
        h2, h3 {
            color: var(--primary-dark);
            margin-bottom: 1.25rem;
            font-weight: 700;
        }

        h2 { font-size: 1.5rem; border-bottom: 2px solid var(--primary-light); padding-bottom: 0.5rem; }
        h3 { font-size: 1.2rem; margin-top: 1rem; }

        p { margin-bottom: 1rem; color: var(--text-color); }
        strong { color: var(--primary-dark); }

        /* Links */
        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }

        a:hover {
            color: var(--primary-dark);
            border-bottom-color: var(--primary-dark);
        }

        /* Formulário */
        form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: -0.75rem;
        }

        input[type=file] {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            background-color: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type=file]:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }

        input[type="submit"] {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
            margin-top: 1rem;
            box-shadow: 0 4px 14px 0 rgba(76, 175, 80, 0.39);
        }

        input[type="submit"]:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.23);
        }

        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        th, td {
            padding: 1rem 1.25rem;
            text-align: left;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:nth-child(even) { background-color: #f8fafc; }
        tr:hover { background-color: var(--primary-light); }

        /* Detalhes */
        details {
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
        }

        summary {
            font-weight: 700;
            color: var(--primary-dark);
            outline: none;
        }

        /* Rodapé */
        footer {
            background-color: var(--white);
            border-top: 1px solid #e2e8f0;
            padding: 3rem 1rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        footer p { margin: 0; }

        /* Utilitários */
        .mt-4 { margin-top: 1rem; }
        
        /* Ajuste para o padding extra que estava no HTML */
        p[style*="padding: 30"] {
            padding: 0 !important;
        }

        /* Responsividade */
        @media (max-width: 640px) {
            header h1 { font-size: 1.75rem !important; }
            div, details { padding: 1.5rem; }
            main { padding: 0 1rem 2rem; }
        }
    </style>
</head>

<body>
    <header>
        <h1 style="font-size: xxx-large;">PAREAMENTO DOS BIXOS FMBRU</h1>
    </header>
    <main>
        <div>
            <p>Para fazer o pareamento você vai precisar coletar as informações dos veteranos e bixos em um formulário do google (um formulário para cada um) e obter um arquivo excel com os pesos de cada questão. Para isso, você deve <strong>seguir as regras</strong> que estão listadas abaixado:</p> 
            <h2>REGRAS:</h2>
            <h3>PARA O FORMS:</h3>
            <p style="padding: 30;">1. O forms dos veteranos e bixos devem ser iguais (perguntas escritas iguais, na
                mesma ordem, com alternativas iguais), por isso recomenda-se <strong>criar um único formulário e duplica-lo</strong> <br>
                2. As respostas devem estar no formato <strong>"escala linear"</strong><br>
                3. Precisa haver uma <strong>pergunta "Nome completo" </strong>(exatamente como está escrita: sem espaço antes ou depois, com o "N" em maiúsculo e o "c" em minúsculo, com um espaço entre as palavras, ...) e uma <strong>pergunta "Número do celular"</strong> (exatamente como está escrita: com acento, com o "N" em maiúsculo, com a preposição de + o, ...) para identificação <br>
                4. <strong>Todas as perguntas devem ser obrigatórias.</strong> Para resolver isso, vá em "configurações padrão das perguntas" e ative a opção mostrada 
            </p>
            <p> <a href="https://docs.google.com/forms/d/1jk-utHSyQ8XhxW28gGrceleI1s82uOnV0n1CMB_P-ZM/edit" target="_blank">Link do forms usado pela T7</a> (por favor, não edite este formulário, apenas faça uma cópia)</p> <br>
            <h3>PARA O ENVIO DOS ARQUIVOS EXCEL:</h3>
            <p>1. No caso das planilhas com respostas dos veteranos e dos bixos, ir para a seção de respostas em seu formulário google e clicar em <strong>"Ver no app Planilhas"</strong> <br>
                2. No canto superior esquerdo do google sheets, clicar em <strong>"Arquivo"</strong>, em seguida clicar em <strong>"Baixar"</strong> e selecionar <strong>"Valores separados por vírgulas (.csv)"</strong> <br>
                3. Pronto, esse é o arquivo que deve ser enviado no campo abaixo<br>
                4. No caso da Planilha de pesos, você poderá baixa-la pelo link abaixo. Caso faça alguma alteração, certifique-se de que o <strong>número de colunas é igual ao número de questões do forms e de que todas as colunas possuem um peso atribuido</strong> <br>
            </p>
            <p> <a href="https://docs.google.com/spreadsheets/d/1Q10443jwj_0M0O6G3AQ8DQGyI2ZjiXsYuBbyC_q-f7Y/edit?usp=sharing" target="_blank">Link para a planilha de pesos da T7</a> (por favor, não edite este arquivo, apenas faça uma cópia)</p>
        </div>
        <div style="padding-bottom: 0;">
            <form id="upload-form">
                <label for="tabela1">Formulário dos veteranos:</label>
                <input type="file" id="tabela1" name="tabela1" accept=".csv" required>
                <label for="tabela2">Formulário dos bixos:</label>
                <input type="file" id="tabela2" name="tabela2" accept=".csv" required>
                <label for="tabela2">Planilha de pesos:</label>
                <input type="file" id="tabelaPesos" name="tabelaPesos" accept=".csv" required>
                <input type="submit" value="PAREAR">
            </form>
            <div id="resultados"></div>
        </div>
        <div>
            <p>Em caso de erro do programa (pareamento fora da ordem crescente, aviso de alerta por ausência da coluna "Nome completo", pareamento com "undefined", entre outros erros): revisar os arquivos excel para ter certeza que a formatação das palavras está correta ou gerar novos arquivos <br>
            </p>
        </div>
        <details style="padding-top: 0;">
            <summary><strong>COMO O CÓDIGO FUNCIONA:</strong></summary>
            <p>1. Ele recebe os arquivos .csv e processa suas informações<br>
                2. Em seguida, usa os valores atribuídos a cada resposta e os pesos de cada questão para calcular a distância entre duas pessoas (isso ocorre com todas as duplas possíveis). <br> <br>
                Distância = &radic; &sum; ( peso . [resposta veterano questão x - resposta bixo questão x] )<sup>2</sup> <br> <br>
                3. Então, pareia as duplas, começando pelas de menor distância (maior afinidade) para as de maior
                distância. <br>
                4. Em caso de empate na distância, ele prioriza o pareamento para aquele bixo que respondeu primeiro <br>
                5. Fornece um pdf com os pares e as pessoas não pareadas. <br>
            </p>
        </details>
    </main>
    <footer>
                <p> &copy João Pedro Bonachini & Gabriel Grossi <br> SAC: (18) 981864191 - Breso T7</p>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <script>
        document.getElementById('upload-form').addEventListener('submit', async function (event) {
            event.preventDefault();
    
            const arquivos = ['tabela1', 'tabela2', 'tabelaPesos'].map(id => document.getElementById(id).files[0]);
            if (arquivos.includes(undefined)) return alert("Por favor, selecione todos os arquivos .csv.");
    
            try {
                const [data1, data2, pesos] = await Promise.all(arquivos.map(parseCSV));
                if (![data1, data2, pesos].every(data => data.length)) return alert("Erro ao carregar arquivos.");
                
                // Confere colunas
                if (!data1[0].hasOwnProperty('Nome completo') || !data2[0].hasOwnProperty('Nome completo') ||
                    !data1[0].hasOwnProperty('Número do celular') || !data2[0].hasOwnProperty('Número do celular')) {
                    return alert("Colunas 'Nome completo' e/ou 'Número do celular' ausente(s) ou escrita(s) incorretamente.");
                }
    
                // Confere pesos
                if (!validarPesos(pesos[0], data1, data2)) return;
    
                // Faz o pareamento
                const resultados = parearPessoas(data1, data2, pesos[0]);
    
                // Gera os PDFs (AGORA COM PORCENTAGEM)
                gerarPDF(resultados, data1, data2);
            } 
            catch (error) {
                console.error("Erro ao processar os arquivos:", error);
            }
        });
    
        // Leitura CSV
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, { header: true, complete: results => resolve(results.data), error: reject });
            });
        }
    
        // Validação de Pesos
        function validarPesos(pesos, tabela1, tabela2) {
            const numPesos = Object.keys(pesos).length;
            const numRespostas = extrairRespostas(tabela1[0]).length;
    
            if (numPesos !== numRespostas || Object.values(pesos).some(p => isNaN(p) || p === ""))
                return alert("Erro: Planilha de pesos com número errado de questões ou peso ausente."), false;
    
            return true;
        }
    
        // Pareamento (Mantém a lógica da Euclidiana Ponderada)
        function parearPessoas(tabela1, tabela2, pesos) {
            const todasCombinacoes = tabela1.flatMap(pessoaA =>
                tabela2.map(pessoaB => {
                    // Bloqueio de Auto-Pareamento
                    if (pessoaA['Nome completo'] === pessoaB['Nome completo'] && 
                        pessoaA['Número do celular'] === pessoaB['Número do celular']) {
                        return null;
                    }
    
                    return {
                        veterano: pessoaA['Nome completo'],
                        telefoneVeterano: pessoaA['Número do celular'],
                        bixo: pessoaB['Nome completo'],
                        telefoneBixo: pessoaB['Número do celular'],
                        // A distância bruta continua sendo usada para ORDENAR (menor é melhor)
                        distancia: calcularDistancia(
                            extrairRespostas(pessoaA),
                            extrairRespostas(pessoaB),
                            Object.values(pesos)
                        ),
                        horario: new Date(pessoaB['Carimbo de data/hora'])
                    };
                })
            );
    
            return todasCombinacoes
                .filter(item => item !== null)
                .sort((a, b) => a.distancia - b.distancia || a.horario - b.horario)
                .reduce((paresAceitos, candidato) => {
                    const vetOcupado = paresAceitos.some(p => 
                        p.veterano === candidato.veterano || p.bixo === candidato.veterano
                    );
                    const bixoOcupado = paresAceitos.some(p => 
                        p.veterano === candidato.bixo || p.bixo === candidato.bixo
                    );
    
                    if (!vetOcupado && !bixoOcupado) {
                        paresAceitos.push(candidato);
                    }
                    return paresAceitos;
                }, []);
        }
    
        function extrairRespostas(pessoa) {
            return Object.values(pessoa).filter(val => !isNaN(parseInt(val)) && val >= 1 && val <= 5);
        }
    
        function calcularDistancia(respostas1, respostas2, pesos) {
            return Math.sqrt(respostas1.reduce((acc, val, i) => acc + pesos[i] * (val - respostas2[i]) ** 2, 0));
        }
    
        // --- MUDANÇA PRINCIPAL AQUI NA GERAÇÃO DO PDF ---
        function gerarPDF(resultados, tabela1, tabela2) {
            const { jsPDF } = window.jspdf;
    
            // 1. Definição do Máximo Teórico para o cálculo da porcentagem
            const MAX_DISTANCIA_POSSIVEL = 20; 
    
            // 2. Lógica de quem já tem par
            const pessoasComPar = new Set();
            resultados.forEach(r => {
                pessoasComPar.add(r.veterano);
                pessoasComPar.add(r.bixo);
            });
    
            const isMesmaTabela = tabela1.length === tabela2.length && 
                                  tabela1[0]['Número do celular'] === tabela2[0]['Número do celular'];
    
            const labelTab1 = isMesmaTabela ? '' : 'Veterano';
            const labelTab2 = isMesmaTabela ? '' : 'Bixo';
    
            // 3. Identificar sobras
            const naoPareados = [];
            const nomesJaListados = new Set(); 
    
            const verificarSobras = (tabela, categoria) => {
                tabela.forEach(pessoa => {
                    const nome = pessoa['Nome completo'];
                    if (!pessoasComPar.has(nome) && !nomesJaListados.has(nome)) {
                        naoPareados.push([nome, categoria]);
                        nomesJaListados.add(nome);
                    }
                });
            };
    
            verificarSobras(tabela1, labelTab1);
            verificarSobras(tabela2, labelTab2);
    
            // 4. Gerar PDF
            const criarDocumento = (titulo, colunas, dados) => {
                const doc = new jsPDF();
    
                doc.autoTable({
                    head: [colunas],
                    body: dados,
                    theme: 'striped',
                    headStyles: { fillColor: [34, 139, 34], textColor: [255, 255, 255] }
                });
    
                if (naoPareados.length) {
                    const headerSobras = isMesmaTabela ? ['Nome', ''] : ['Nome', 'Categoria'];
                    doc.autoTable({
                        head: [headerSobras],
                        body: naoPareados,
                        startY: doc.autoTable.previous.finalY + 10,
                        theme: 'striped',
                        headStyles: { fillColor: [231, 76, 60], textColor: [255, 255, 255] }
                    });
                }
                doc.save(titulo);
            };
    
            // --- AQUI ACONTECE A CONVERSÃO PARA PORCENTAGEM ---
            const dadosComCompatibilidade = resultados.map(r => {
                // Fórmula: (1 - (distância / maximo)) * 100
                // Se a distância for maior que 20 por algum erro de dado, travamos em 0%
                let porcentagem = (1 - (r.distancia / MAX_DISTANCIA_POSSIVEL)) * 100;
                if (porcentagem < 0) porcentagem = 0;
                
                return [
                    r.veterano, 
                    r.bixo, 
                    porcentagem.toFixed(2) + '%', // Exibe ex: "95.50%"
                    r.telefoneBixo
                ];
            });
    
            const dadosSemDistancia = resultados.map(r => [r.veterano, r.bixo, r.telefoneBixo]);
    
            const headerEsq = isMesmaTabela ? 'Pessoa 1' : 'Veterano';
            const headerDir = isMesmaTabela ? 'Pessoa 2' : 'Bixo';
    
            // Mudei o cabeçalho de 'Distância' para 'Compatibilidade'
            criarDocumento('pareamento_com_compatibilidade.pdf', [headerEsq, headerDir, 'Compatibilidade', 'Tel. ' + headerDir], dadosComCompatibilidade);
            criarDocumento('pareamento_sem_compatibilidade.pdf', [headerEsq, headerDir, 'Tel. ' + headerDir], dadosSemDistancia);
        }
    </script>                                               
</body>
</html>


<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>PAREAMENTO DOS BIXOS FMBRU</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            font-weight: 100;
        }

        header {
            padding: 3rem;
            background-color: #4CAF50;
            color: #fffdfd;
            text-align: center;
        }

        main {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 0;
        }

        main::before {
            content: '';
            position: absolute;
            padding: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/b8/Logo_FMBRU.jpg');
            opacity: 0.07;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }

        footer {
            background-color: #4CAF50;
            color: white;
            text-align: end;
            padding: 0;
            margin: 0;
            width: 100%;
            position: 0;
            bottom: 0;
        }

        div, details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 3rem;
        }

        h4 {
            font-weight: 100;
        }

        p {
            padding: 0.5rem;
            ;
        }
        
        a {
            color: #1d591f;
        }
        
        form {
            background-color: white;
            padding: 1rem;
            margin-left: 5rem;
            margin-right: 18rem;
            border-radius: 7px;
            text-align: left;
            box-shadow: 0 0 10px #1d591f;
        }

        input[type=file] {
            display: block;
            margin-bottom: 20px;
        }

        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 75%;
            border-collapse: collapse;
            border-radius: 5px;
            margin-top: 2rem;
            margin-left: 5rem;
            margin-right: 18rem;
            box-shadow: 0 0 10px #1d591f;
        }

        table,
        th,
        td {
            border: 1px solid #1d591f;
        }

        th,
        td {
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #4CAF50;
        }
    </style>
</head>

<body>
    <header>
        <h1>PAREAMENTO DOS BIXOS FMBRU</h1>
        
    </header>
    <main>
        <div>
            <p>Para fazer o pareamento você vai precisar coletar as informações dos veteranos e bixos em um formulário do google (um formulário para cada um), e criar um arquivo excel das respostas para que seja lido pelo programa. Nesse sentido, você vai precisar seguir algumas regras que estão listadas abaixado:</p> 
            <h2>REGRAS:</h2>
            <h3>PARA O FORMS:</h3>
            <p>O formulário google irá gerar o arquivo a ser lido pelo código, ele precisa estar bem
                padronizado a fim de evitar erros. Seguem algumas dicas para produção do formulário google que devem ser
                seguidas para garantir o bom funcionamento: </p>
            <p style="padding: 30;">1. O forms dos veteranos e bixos devem ser iguais (perguntas escritas iguais, na
                mesma ordem, com alternativas iguais), por isso recomenda-se <strong>criar apenas um formulário e duplica-lo</strong>,
                para enviar o original aos veteranos e a cópia aos bixos. <br>
                2. As respostas devem estar no formato <strong>"escala linear"</strong>, para que elas representem
                números que serão posteriormente usados nas contas do pareamento <br>
                3. Precisa haver uma <strong>pergunta "Nome completo" </strong>(sem espaço antes ou depois, com o "N" em maiúsculo e o "c" em minúsculo, com um espaço entre as palavras, ...), pois o código irá usar a resposta dessa
                pergunta para identificação <br>
                4. <strong>Todas as perguntas devem ser obrigatórias.</strong> Para resolver isso, vá em 
                "configurações" na página de edição do seu formulário, depois em "configurações padrão das perguntas" e ative a opção mostrada 
            </p>
            <p> <a href="https://docs.google.com/forms/d/1scSjYEnIoE-pquUbUA0wVQui36osaZkOLSuaNPQz3VI/edit" target="_blank">Link do forms usado pela T7</a></p> <br>
            <h3>PARA O ENVIO DO ARQUIVO EXCEL:</h3>
            <p>Para conseguir um arquivo correto com as respostas dos veteranos e bixos, você precisará seguir o
                seguinte passo a passo: <br>
            </p>
            <p>1. Ir para a seção de respostas em seu formulário google e clicar em <strong>"Ver no app
                    Planilhas"</strong> <br>
                2. No google sheets, clicar em <strong>"Arquivo"</strong> na parte de cima da esquerda <br>
                3. Em seguida clicar em <strong>"Baixar"</strong>, e selecionar <strong>"Valores separados por vírgulas
                    (.csv)"</strong> <br>
                4. Pronto, esse é o arquivo que deve ser enviado no campo abaixo, tanto para o formulário dos veteranos
                quanto para o dos bixos <br>
                5. <strong>Se forem necessárias novas rodadas de pareamento deve-se criar um novo forms</strong> (com as
                respostas daqueles que não estão pareados ainda) ou apagar todas as respostas das pessoas já pareadas lá
                no google sheets <br>
            </p>
            <p>Em caso de erro do programa (pareamento fora da ordem crescente, aviso de alerta por ausência da coluna "Nome completo", pareamento com "undefined", entre outros erros): revisar o arquivo excel para ter certeza que a formatação das palavras está correta ou gerar um novo arquivo a partir do forms
            </p>
        </div>
        <div style="padding-bottom: 0;">
            <form id="upload-form">
                <label for="tabela1">Formulários dos veteranos:</label>
                <input type="file" id="tabela1" name="tabela1" accept=".csv" required>
                <label for="tabela2">Formulários dos bixos:</label>
                <input type="file" id="tabela2" name="tabela2" accept=".csv" required>
                <input type="submit" value="Comparar">
            </form>
            <div id="resultados"></div>
        </div>
        <details style="padding-top: 0;">
            <summary><strong>COMO O CÓDIGO FUNCIONA:</strong></summary>
            <p>O código foi feito para realizar o seguinte passo a passo: <br>
                1. Ele recebe o input dos arquivos .csv, garante que ambos foram recebidos e processa suas informações<br>
                2. Em seguida, usa os valores atribuídos a cada resposta para calcular a distância euclidiana entre duas
                pessoas (isso ocorre com todas as pessoas, ou seja, ele calcula a distancia entre todas as duplas
                possíveis). <br>
                3. Então, pareia as duplas, começando pelas de menor distância (maior afinidade) para as de menor
                distância. <br>
                4. Exibe os resultados numa tabela e fornece um pdf com os pares e as pessoas não pareadas. <br>
            </p>
        </details>
        <main>
            <footer>
                <p> <br> &copy João Pedro Bonachini e Gabriel Grossi<br> </p>
            </footer>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
            <script
                src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>

            <script>
                document.getElementById('upload-form').addEventListener('submit', function (event) {
                    event.preventDefault();
                    const tabela1 = document.getElementById('tabela1').files[0];
                    const tabela2 = document.getElementById('tabela2').files[0];
                    if (!tabela1 || !tabela2) {
                        alert("Por favor, selecione ambos os arquivos .csv.");
                        return;
                    }
                    Promise.all([parseCSV(tabela1), parseCSV(tabela2)])
                        .then(([data1, data2]) => {
                            console.log(data1);
                            console.log(data2);
                            if (data1.length === 0 || data2.length === 0) {
                                alert("Um dos arquivos .csv está vazio ou não pôde ser lido.");
                                return;
                            }
                            if (!data1[0].hasOwnProperty('Nome completo') || !data2[0].hasOwnProperty('Nome completo')) {
                                alert("Um dos arquivos .csv não contém a coluna 'Nome completo'.");
                                return;
                            }
                            const resultados = compararTabelas(data1, data2);
                            exibirResultados(resultados);
                            salvarResultadosPDF(resultados, data1, data2);
                            if (resultados.length > 0) {
                                marcarNaoPareados(data1, data2, resultados);
                            }
                        });
                });

                function parseCSV(file) {
                    return new Promise((resolve, reject) => {
                        Papa.parse(file, {
                            header: true,
                            complete: results => resolve(results.data),
                            error: err => reject(err)
                        });
                    });
                }

                function calcularDistanciaEuclidiana(respostas1, respostas2) {
                    const somaQuadrados = respostas1.reduce((acc, val, index) => {
                        const diferenca = parseInt(val) - parseInt(respostas2[index]);
                        return acc + (diferenca * diferenca);
                    }, 0);
                    return Math.sqrt(somaQuadrados);
                }

                function extrairRespostasEscala(pessoa) {
                    return Object.keys(pessoa)
                        .filter(key => {
                            const valor = parseInt(pessoa[key]);
                            return !isNaN(valor) && valor >= 1 && valor <= 5; // Verifica se é um número na escala de 1 a 5
                        })
                        .map(key => pessoa[key]);
                }

                function compararTabelas(tabela1, tabela2) {
                    const resultados = [];
                    tabela1.forEach(pessoa1 => {
                        if (!pessoa1['Pareado']) {
                            tabela2.forEach(pessoa2 => {
                                if (!pessoa2['Pareado']) {
                                    const respostas1 = extrairRespostasEscala(pessoa1);
                                    const respostas2 = extrairRespostasEscala(pessoa2);
                                    const distancia = calcularDistanciaEuclidiana(respostas1, respostas2);
                                    resultados.push({
                                        pessoaTabela1: pessoa1['Nome completo'],
                                        telefoneVeterano: String(pessoa1['Numero do celular']),
                                        pessoaTabela2: pessoa2['Nome completo'],
                                        distancia: distancia,
                                        telefoneBixo: String(pessoa2['Numero do celular']),
                                        horario1: new Date(pessoa1['Carimbo de data/hora']),
                                        horario2: new Date(pessoa2['Carimbo de data/hora'])
                                    });
                                }
                            });
                        }
                    });
                    resultados.sort((a, b) => a.distancia - b.distancia);
                    const melhoresResultados = [];
                    const usadosTabela1 = new Set();
                    const usadosTabela2 = new Set();
                    for (const resultado of resultados) {
                        if (!usadosTabela1.has(resultado.pessoaTabela1) && !usadosTabela2.has(resultado.pessoaTabela2)) {
                            melhoresResultados.push(resultado);
                            usadosTabela1.add(resultado.pessoaTabela1);
                            usadosTabela2.add(resultado.pessoaTabela2);
                        }
                    }
                    return melhoresResultados;
                }

                function exibirResultados(resultados) {
                    const resultadosDiv = document.getElementById('resultados');
                    resultadosDiv.innerHTML = '';
                    if (resultados.length === 0) {
                        resultadosDiv.textContent = "Nenhum resultado encontrado.";
                        return;
                    }
                    const tabela = document.createElement('table');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');
                    const cabecalho = ['Veteranos', 'Bixos', 'Distância', 'Telefone do Veterano', 'Telefone do Bixo'];
                    const tr = document.createElement('tr');
                    cabecalho.forEach(text => {
                        const th = document.createElement('th');
                        th.textContent = text;
                        tr.appendChild(th);
                    });
                    thead.appendChild(tr);
                    tabela.appendChild(thead);
                    resultados.forEach(resultado => {
                        const tr = document.createElement('tr');
                        ['pessoaTabela1', 'pessoaTabela2', 'distancia', 'telefoneVeterano', 'telefoneBixo'].forEach(key => {
                            const td = document.createElement('td');
                            if (key === 'distancia') {
                                td.textContent = parseFloat(resultado[key]).toFixed(2); // Formatar para 2 casas decimais
                            } else {
                                td.textContent = resultado[key] || " ";
                            }
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    tabela.appendChild(tbody);
                    resultadosDiv.appendChild(tabela);
                }

                function marcarNaoPareados(tabela1, tabela2, resultados) {
                    tabela1.forEach(pessoa => {
                        if (!resultados.some(r => r.pessoaTabela1 === pessoa['Nome completo'])) {
                            pessoa['Pareado'] = 'Nao';
                        }
                    });
                    tabela2.forEach(pessoa => {
                        if (!resultados.some(r => r.pessoaTabela2 === pessoa['Nome completo'])) {
                            pessoa['Pareado'] = 'Nao';
                        }
                    });
                }

                function salvarResultadosPDF(resultados, tabela1, tabela2) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    const dadosTabela = resultados.map(resultado => [
                        resultado.pessoaTabela1,
                        resultado.pessoaTabela2,
                        resultado.distancia.toFixed(2),
                        resultado.telefoneVeterano,
                        resultado.telefoneBixo
                    ]);

                    doc.autoTable({
                        head: [['Veteranos', 'Bixos', 'Distância', 'Telefone do Veterano', 'Telefone do Bixo']],
                        body: dadosTabela,
                        theme: 'striped',
                        headStyles: { fillColor: [34, 139, 34], textColor: [255, 255, 255] },
                        styles: { fillColor: false, textColor: [0, 0, 0] }
                    });

                    const naoPareadosTabela1 = tabela1.filter(p => !resultados.some(r => r.pessoaTabela1 === p['Nome completo'])).map(p => [p['Nome completo'], 'Veterano']);
                    const naoPareadosTabela2 = tabela2.filter(p => !resultados.some(r => r.pessoaTabela2 === p['Nome completo'])).map(p => [p['Nome completo'], 'Bixo']);

                    if (naoPareadosTabela1.length > 0 || naoPareadosTabela2.length > 0) {
                        doc.autoTable({
                            head: [['Nome completo - Não Pareados', 'Categoria']],
                            body: [...naoPareadosTabela1, ...naoPareadosTabela2],
                            startY: doc.autoTable.previous.finalY + 10,
                            theme: 'striped',
                            headStyles: { fillColor: [231, 76, 60], textColor: [255, 255, 255] },
                            styles: { fillColor: false, textColor: [0, 0, 0] }
                        });
                    }

                    doc.save('resultados_pareamento.pdf');
                }
            </script>

</body>

</html>
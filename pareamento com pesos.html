<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>PAREAMENTO DOS BIXOS FMBRU</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            font-weight: 100;
        }

        header {
            padding: 3rem;
            background-color: #4CAF50;
            color: #fffdfd;
            text-align: center;
        }

        main {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 0;
        }

        main::before {
            content: '';
            position: absolute;
            padding: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/b8/Logo_FMBRU.jpg');
            opacity: 0.07;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }

        footer {
            background-color: #4CAF50;
            color: white;
            text-align: end;
            padding: 0;
            margin: 0;
            width: 100%;
            position: 0;
            bottom: 0;
        }

        div, details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 3rem;
        }

        h4 {
            font-weight: 100;
        }

        p {
            padding: 0.5rem;
            ;
        }
        
        a {
            color: #1d591f;
        }
        
        form {
            background-color: white;
            padding: 1rem;
            margin-left: 5rem;
            margin-right: 18rem;
            border-radius: 7px;
            text-align: left;
            box-shadow: 0 0 10px #1d591f;
        }

        input[type=file] {
            display: block;
            margin-bottom: 20px;
        }

        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 75%;
            border-collapse: collapse;
            border-radius: 5px;
            margin-top: 2rem;
            margin-left: 5rem;
            margin-right: 18rem;
            box-shadow: 0 0 10px #1d591f;
        }

        table,
        th,
        td {
            border: 1px solid #1d591f;
        }

        th,
        td {
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #4CAF50;
        }
    </style>
</head>

<body>
    <header>
        <h1>PAREAMENTO DOS BIXOS FMBRU</h1>
        <p>o site que vai cuidar do orfanto dos seus queridos filhos de faculdade</p>
    </header>
    <main>
        <div>
            <p>Para fazer o pareamento você vai precisar coletar as informações dos veteranos e bixos em um formulário do google (um formulário para cada um) e obter um arquivo excel com os pesos de cada questão, para que sejam lidos pelo programa. Nesse sentido, você vai precisar seguir algumas regras que estão listadas abaixado:</p> 
            <h2>REGRAS:</h2>
            <h3>PARA O FORMS:</h3>
            <p>O formulário google irá gerar o arquivo a ser lido pelo código, ele precisa estar bem
                padronizado a fim de evitar erros. Seguem algumas dicas para produção do formulário que devem ser
                seguidas para garantir o bom funcionamento: </p>
            <p style="padding: 30;">1. O forms dos veteranos e bixos devem ser iguais (perguntas escritas iguais, na
                mesma ordem, com alternativas iguais), por isso recomenda-se <strong>criar apenas um formulário e duplica-lo</strong> <br>
                2. As respostas devem estar no formato <strong>"escala linear" de 1 a 3</strong> <br>
                3. Precisa haver uma <strong>pergunta "Nome completo" </strong>(sem espaço antes ou depois, com o "N" em maiúsculo e o "c" em minúsculo, com um espaço entre as palavras, ...) e uma <strong>pergunta "Número do celular"</strong> (com acento, com o "N" em maiúsculo, com a preposição de + o, ...) para identificação <br>
                4. <strong>Todas as perguntas devem ser obrigatórias.</strong> Para resolver isso ative a opção em "configurações padrão das perguntas"
            </p>
            <p> <a href="https://docs.google.com/forms/d/14JJjSAY2wxxQf-J_-8F4PtbVFFRs4U-GPdSxbVZlVFY/edit" target="_blank">Link do forms usado pela T7</a> (por favor, não edite este formulário)</p> <br>
            <h3>PARA O ENVIO DOS ARQUIVOS EXCEL:</h3>
            <p>Para conseguir um arquivo correto com as respostas dos veteranos e bixos, você precisará seguir o
                seguinte passo a passo: <br>
            </p>
            <p>1. No caso das planilhas com respostas, ir para a seção de respostas em seu formulário google e clicar em <strong>"Ver no app Planilhas"</strong> <br>
                2. No caso da Planilha de pesos, você poderá baixa-lá pelo link abaixo. Caso faça alguma alteração, certifique-se de que o <strong>número de colunas é igual ao número de questões e de que todas as colunas possuem um peso atribuido</strong> <br>
                3. No google sheets, clicar em <strong>"Arquivo"</strong> na parte de cima da esquerda, em seguida clicar em <strong>"Baixar"</strong>, e selecionar <strong>"Valores separados por vírgulas (.csv)"</strong> <br>
                4. Pronto, esse é o arquivo que deve ser enviado no campo abaixo, tanto para o formulário dos veteranos
                quanto para o dos bixos, quanto para a planilha de pesos <br>
            </p>
            <p> <a href="https://docs.google.com/spreadsheets/d/1Q10443jwj_0M0O6G3AQ8DQGyI2ZjiXsYuBbyC_q-f7Y/edit?usp=sharing" target="_blank">Link para a planilha de pesos da T7</a> (por favor, não edite este arquivo, apenas faça uma cópia)</p>
            <p>Em caso de erro do programa (pareamento fora da ordem crescente, aviso de alerta por ausência da coluna "Nome completo", pareamento com "undefined", resultado NaN, entre outros erros): revisar os arquivos excel para ter certeza que a formatação das palavras está correta ou gerar novos arquivos
            </p>
            <p><strong>Se forem necessárias novas rodadas de pareamento deve-se criar novos formulários</strong> (com as
            respostas daqueles que não estão pareados ainda) ou apagar todas as respostas das pessoas já pareadas lá
            no google sheets <br>
            </p>
        </div>
        <div style="padding-bottom: 0;">
            <form id="upload-form">
                <label for="tabela1">Formulário dos veteranos:</label>
                <input type="file" id="tabela1" name="tabela1" accept=".csv" required>
                <label for="tabela2">Formulário dos bixos:</label>
                <input type="file" id="tabela2" name="tabela2" accept=".csv" required>
                <label for="tabela2">Planilha de pesos:</label>
                <input type="file" id="tabelaPesos" name="tabelaPesos" accept=".csv" required>
                <input type="submit" value="PAREAR">
            </form>
            <div id="resultados"></div>
        </div>
        <details style="padding-top: 0;">
            <summary><strong>COMO O CÓDIGO FUNCIONA:</strong></summary>
            <p>O código foi feito para realizar o seguinte passo a passo: <br>
                1. Ele recebe o input dos arquivos .csv, garante que todos foram recebidos e processa suas informações<br>
                2. Em seguida, usa os valores atribuídos a cada resposta e os pesos de cada questão para calcular a distância euclidiana ponderada entre duas pessoas (isso ocorre com todas as pessoas, ou seja, ele calcula a distancia entre todas as duplas possíveis). <br> <br>
                Distância = &radic; &sum; ( peso [resposta veterano questão x - resposta bixo questão x] )<sup>2</sup> <br> <br>
                3. Então, pareia as duplas, começando pelas de menor distância (maior afinidade) para as de maior
                distância. <br>
                4.Em caso de empate na distância, ele prioriza o pareamento para aquele bixo que respondeu primeiro <br>
                5. Exibe os resultados numa tabela e fornece um pdf com os pares e as pessoas não pareadas. <br>
            </p>
        </details>
        <main>
            <footer>
                <p> <br> &copy João Pedro Bonachini<br> </p>
            </footer>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
            <script
                src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
                <script>
                    // Adiciona um listener para o evento de submissão do formulário
                    document.getElementById('upload-form').addEventListener('submit', function (event) {
                        event.preventDefault(); // Impede o comportamento padrão de envio do formulário
                
                        // Obtém os arquivos selecionados
                        const tabela1 = document.getElementById('tabela1').files[0];
                        const tabela2 = document.getElementById('tabela2').files[0];
                        const tabelaPesos = document.getElementById('tabelaPesos').files[0];
                
                        // Verifica se todos os arquivos foram selecionados
                        if (!tabela1 || !tabela2 || !tabelaPesos) {
                            alert("Por favor, selecione todos os arquivos .csv.");
                            return;
                        }
                
                        // Faz o parsing de todos os arquivos .csv em paralelo
                        Promise.all([parseCSV(tabela1), parseCSV(tabela2), parseCSV(tabelaPesos)])
                            .then(([data1, data2, dataPesos]) => {
                                console.log(data1); // Exibe a tabela 1 no console para depuração
                                console.log(data2); // Exibe a tabela 2 no console para depuração
                                console.log(dataPesos); // Exibe a tabela de pesos no console para depuração
                
                                // Verifica se algum arquivo está vazio
                                if (data1.length === 0 || data2.length === 0 || dataPesos.length === 0) {
                                    alert("Um dos arquivos .csv está vazio ou não pôde ser lido.");
                                    return;
                                }
                
                                // Verifica se as tabelas contêm a coluna 'Nome completo'
                                if (!data1[0].hasOwnProperty('Nome completo') || !data2[0].hasOwnProperty('Nome completo')) {
                                    alert("Um dos arquivos .csv não contém a coluna 'Nome completo'.");
                                    return;
                                }
                
                                // Compara as tabelas utilizando a tabela de pesos
                                const resultados = compararTabelas(data1, data2, dataPesos[0]);
                
                                // Exibe os resultados na interface
                                exibirResultados(resultados);
                
                                // Gera os PDFs com os resultados
                                salvarResultadosPDF(resultados, data1, data2);
                
                                // Marca as pessoas não pareadas
                                if (resultados.length > 0) {
                                    marcarNaoPareados(data1, data2, resultados);
                                }
                            });
                    });
                
                    // Função para realizar o parsing de um arquivo .csv usando a biblioteca PapaParse
                    function parseCSV(file) {
                        return new Promise((resolve, reject) => {
                            Papa.parse(file, {
                                header: true, // Interpreta a primeira linha como cabeçalho
                                complete: results => resolve(results.data), // Retorna os dados do arquivo
                                error: err => reject(err) // Retorna o erro em caso de falha
                            });
                        });
                    }
                
                    // Calcula a distância euclidiana ponderada entre duas listas de respostas
                    function calcularDistanciaEuclidianaComPesos(respostas1, respostas2, pesos) {
                        const somaQuadradosPonderados = respostas1.reduce((acc, val, index) => {
                            const diferenca = parseInt(val) - parseInt(respostas2[index]);
                            const quadradoPonderado = pesos[index] * (diferenca * diferenca);
                            return acc + quadradoPonderado;
                        }, 0);
                        return Math.sqrt(somaQuadradosPonderados); // Retorna a raiz quadrada da soma
                    }
                
                    // Extrai apenas as respostas na escala de 1 a 5 de uma pessoa
                    function extrairRespostasEscala(pessoa) {
                        return Object.keys(pessoa)
                            .filter(key => {
                                const valor = parseInt(pessoa[key]);
                                return !isNaN(valor) && valor >= 1 && valor <= 3; // Verifica se o valor é válido
                            })
                            .map(key => pessoa[key]); // Retorna as respostas
                    }
                
                    // Compara as tabelas, calculando as distâncias entre todas as combinações e selecionando os melhores pares
                    function compararTabelas(tabela1, tabela2, pesos) {
                        const resultados = [];
                
                        // Itera sobre cada pessoa da tabela 1
                        tabela1.forEach(pessoa1 => {
                            if (!pessoa1['Pareado']) {
                                // Itera sobre cada pessoa da tabela 2
                                tabela2.forEach(pessoa2 => {
                                    if (!pessoa2['Pareado']) {
                                        const respostas1 = extrairRespostasEscala(pessoa1);
                                        const respostas2 = extrairRespostasEscala(pessoa2);
                                        const pesosArray = Object.values(pesos);
                                        if (respostas1.length !== respostas2.length || respostas1.length !== pesosArray.length) {
                                            alert("Erro: O número de respostas e o número de pesos não correspondem.");
                                            return Infinity; // Sai do loop atual sem calcular a distância
                                        }
                                        
                                        const distancia = calcularDistanciaEuclidianaComPesos(respostas1, respostas2, Object.values(pesos));
                
                                        // Adiciona o resultado ao array de resultados
                                        resultados.push({
                                            pessoaTabela1: pessoa1['Nome completo'],
                                            telefoneVeterano: String(pessoa1['Número do celular']),
                                            pessoaTabela2: pessoa2['Nome completo'],
                                            distancia: distancia,
                                            telefoneBixo: String(pessoa2['Número do celular']),
                                            horario1: new Date(pessoa1['Carimbo de data/hora']),
                                            horario2: new Date(pessoa2['Carimbo de data/hora'])
                                        });
                                    }
                                });
                            }
                        });
                
                        // Ordena os resultados por distância e, em caso de empate, pela data de resposta
                        resultados.sort((a, b) => {
                            if (a.distancia === b.distancia) {
                                return a.horario2 - b.horario2; // Critério secundário
                            }
                            return a.distancia - b.distancia; // Critério principal
                        });
                
                        // Seleciona os melhores pares sem repetir pessoas
                        const melhoresResultados = [];
                        const usadosTabela1 = new Set();
                        const usadosTabela2 = new Set();
                        for (const resultado of resultados) {
                            if (!usadosTabela1.has(resultado.pessoaTabela1) && !usadosTabela2.has(resultado.pessoaTabela2)) {
                                melhoresResultados.push(resultado);
                                usadosTabela1.add(resultado.pessoaTabela1);
                                usadosTabela2.add(resultado.pessoaTabela2);
                            }
                        }
                
                        return melhoresResultados;
                    }
                
                    // Exibe os resultados do pareamento na interface
                    function exibirResultados(resultados) {
                        const resultadosDiv = document.getElementById('resultados');
                        resultadosDiv.innerHTML = '';
                
                        if (resultados.length === 0) {
                            resultadosDiv.textContent = "Nenhum resultado encontrado.";
                            return;
                        }
                
                        // Cria uma tabela para exibir os resultados
                        const tabela = document.createElement('table');
                        const thead = document.createElement('thead');
                        const tbody = document.createElement('tbody');
                
                        // Define o cabeçalho da tabela
                        const cabecalho = ['Veteranos', 'Bixos', 'Distância', 'Telefone do Veterano', 'Telefone do Bixo'];
                        const tr = document.createElement('tr');
                        cabecalho.forEach(text => {
                            const th = document.createElement('th');
                            th.textContent = text;
                            tr.appendChild(th);
                        });
                        thead.appendChild(tr);
                        tabela.appendChild(thead);
                
                        // Preenche a tabela com os resultados
                        resultados.forEach(resultado => {
                            const tr = document.createElement('tr');
                            ['pessoaTabela1', 'pessoaTabela2', 'distancia', 'telefoneVeterano', 'telefoneBixo'].forEach(key => {
                                const td = document.createElement('td');
                                if (key === 'distancia') {
                                    td.textContent = parseFloat(resultado[key]).toFixed(5); // Formata para 5 casas decimais
                                } else {
                                    td.textContent = resultado[key] || " ";
                                }
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                
                        tabela.appendChild(tbody);
                        resultadosDiv.appendChild(tabela);
                    }
                
                    // Marca as pessoas que não foram pareadas
                    function marcarNaoPareados(tabela1, tabela2, resultados) {
                        tabela1.forEach(pessoa => {
                            if (!resultados.some(r => r.pessoaTabela1 === pessoa['Nome completo'])) {
                                pessoa['Pareado'] = 'Nao';
                            }
                        });
                
                        tabela2.forEach(pessoa => {
                            if (!resultados.some(r => r.pessoaTabela2 === pessoa['Nome completo'])) {
                                pessoa['Pareado'] = 'Nao';
                            }
                        });
                    }
                
                    // Gera os PDFs com os resultados do pareamento
                    function salvarResultadosPDF(resultados, tabela1, tabela2) {
                        const { jsPDF } = window.jspdf;
                
                        // Cria o primeiro PDF com as informações principais
                        const doc1 = new jsPDF();
                        const dadosTabela = resultados.map(resultado => [
                            resultado.pessoaTabela1,
                            resultado.pessoaTabela2,
                            resultado.distancia.toFixed(5),
                            resultado.telefoneVeterano,
                            resultado.telefoneBixo
                        ]);
                
                        doc1.autoTable({
                            head: [['Veteranos', 'Bixos', 'Distância', 'Telefone do Veterano', 'Telefone do Bixo']],
                            body: dadosTabela,
                            theme: 'striped',
                            headStyles: { fillColor: [34, 139, 34], textColor: [255, 255, 255] },
                            styles: { fillColor: false, textColor: [0, 0, 0] }
                        });
                
                        // Adiciona uma tabela com os não pareados
                        const naoPareadosTabela1 = tabela1.filter(p => !resultados.some(r => r.pessoaTabela1 === p['Nome completo'])).map(p => [p['Nome completo'], 'Veterano']);
                        const naoPareadosTabela2 = tabela2.filter(p => !resultados.some(r => r.pessoaTabela2 === p['Nome completo'])).map(p => [p['Nome completo'], 'Bixo']);
                
                        if (naoPareadosTabela1.length > 0 || naoPareadosTabela2.length > 0) {
                            doc1.autoTable({
                                head: [['Não Pareados', 'Categoria']],
                                body: [...naoPareadosTabela1, ...naoPareadosTabela2],
                                startY: doc1.autoTable.previous.finalY + 10,
                                theme: 'striped',
                                headStyles: { fillColor: [231, 76, 60], textColor: [255, 255, 255] },
                                styles: { fillColor: false, textColor: [0, 0, 0] }
                            });
                        }
                
                        doc1.save('resultados_pareamento.pdf');
                
                        // Cria o segundo PDF com menos informações (sem distância)
                        const doc2 = new jsPDF();
                        const dadosTabela2 = resultados.map(resultado => [
                            resultado.pessoaTabela1,
                            resultado.pessoaTabela2,
                            resultado.telefoneVeterano,
                            resultado.telefoneBixo,
                        ]);
                
                        doc2.autoTable({
                            head: [['Veteranos', 'Bixos', 'Telefone do Veterano', 'Telefone do Bixo']],
                            body: dadosTabela2,
                            theme: 'striped',
                            headStyles: { fillColor: [34, 139, 34], textColor: [255, 255, 255] },
                            styles: { fillColor: false, textColor: [0, 0, 0] }
                        });
                
                        if (naoPareadosTabela1.length > 0 || naoPareadosTabela2.length > 0) {
                            doc2.autoTable({
                                head: [['Não Pareados', 'Categoria']],
                                body: [...naoPareadosTabela1, ...naoPareadosTabela2],
                                startY: doc2.autoTable.previous.finalY + 10,
                                theme: 'striped',
                                headStyles: { fillColor: [231, 76, 60], textColor: [255, 255, 255] },
                                styles: { fillColor: false, textColor: [0, 0, 0] }
                            });
                        }
                
                        doc2.save('resultados_pareamento_sem_distancia.pdf');
                    }
                </script>
                
</body>

</html>
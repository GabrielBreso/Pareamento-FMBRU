<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Comparação de Respostas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            font-weight: 100;
        }

        header {
            padding: 3rem;
            background-color: #4CAF50;
            color: #fffdfd;
            text-align: center;
        }

        main {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 0;
        }
        main::before { 
            content: ''; 
            position: absolute; 
            padding: 0;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background-image: url('https://www.rbsdirect.com.br/imagesrc/35560467.jpg?version=1575255600://e7.pngegg.com/pngimages/192/240/png-clipart-rod-of-asclepius-staff-of-hermes-caduceus-as-a-symbol-of-medicine-symbol-miscellaneous-leaf-thumbnail.png');
            opacity: 0.05;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }

        footer {
            background-color: #4CAF50; 
            color: white; 
            text-align: center; 
            padding: 0;
            margin: 0;
            width: 100%;
            position: 0; 
            bottom: 0;
        }
        
        div {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 3rem;
        }

        h4 {
            font-weight: 100;
        }

        p {
            padding: 0.5rem;;
        }

        form {
            background-color: white;
            padding: 1rem;
            margin-left: 5rem;
            margin-right: 18rem;
            border-radius: 7px;
            text-align: left;
            box-shadow: 0 0 10px #1d591f;
        }

        input[type=file] {
            display: block;
            margin-bottom: 20px;
        }

        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 75%;
            border-collapse: collapse;
            border-radius: 5px;
            margin-top: 2rem;
            margin-left: 5rem;
            margin-right: 18rem;
            box-shadow: 0 0 10px #1d591f;
        }

        table, th, td {
            border: 1px solid #1d591f;
        }

        th, td {
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #4CAF50;
        }

    </style>
</head>

<body>
    <header>
        <h1>COMPARAÇÃO DE RESPOSTAS</h1>
    </header>
    <main>
        <div>
            <h2>REGRAS:</h2>
            <h3>PARA O FORMS:</h3>
            <h4>O formulário google é o que irá gerar o arquivo a ser lido pelo código, portanto, ele precisa estar bem
                padronizado a fim de evitar erros. Seguem algumas dicas para produção do formulário google que devem ser
                seguidas para garantir um bom funcionamento: </h4>
            <p>1. O forms dos veteranos e bixos devem ser iguais (perguntas escritas iguais, na mesma ordem, com
                alternativas iguais), por isso recomenda-se <strong>criar apenas um formulário e duplica-lo</strong>,
                para enviar o original aos veteranos e a cópia aos bixos. <br>
                2. As respostas devem estar no formato <strong>"escala linear"</strong>, para que elas representem
                números que serão posteriormente usados nas contas do pareamento <br>
                3. Precisa haver uma <strong>pergunta "Nome completo"</strong>, pois o código irá usar a resposta dessa
                pergunta para identificação <br>
                4. <strong>Todas as perguntas devem ser obrigatórias.</strong> Para resolver isso, vá para configurações, configurações padrão das perguntas e ative a opção mostrada. <br>
                5. As respostas devem vir <strong>ser nenhum caracter especial</strong> (o celular não pode apresentar parenteses no DDD nem hifen no meio do número); se alguém responder com caracter especial, a pessoa encarregada do forms e do google sheets deve alterar isso na planilha
            </p>
            <p>Link do forms usado pela T7</p>
            <h3>PARA O ENVIO DO ARQUIVO EXCEL:</h3>
            <p>Para conseguir um arquvio correto com as respostas dos veteranos e bixos, você precisará seguir o
                seguinte passo a passo: <br>
            </p>
            <p>1. Ir para a seção de respostas em seu formulário google e clicar em <strong>"Ver no app
                    Planilhas"</strong> <br>
                2. No google sheets, clicar em <strong>"Arquivo"</strong> na parte de cima da esquerda <br>
                3. Em seguida clicar em <strong>"Baixar"</strong>, e selecionar <strong>"Valores separados por vírgulas
                    (.csv)"</strong> <br>
                4. Pronto, esse é o arquivo que deve ser enviado no campo ao lado, tanto para o formulário dos veteranos
                quanto para o dos bixos <br>
                5. <strong>Se forem necessárias novas rodadas de pareamento deve-se criar um novo forms</strong> (com as respostas daqueles que não estão pareados ainda) ou apagar todas as respostas das pessoas já pareadas lá no google sheets <br>
            </p>
        </div>
        <div>
            <form id="upload-form">
                <label for="tabela1">Formulários dos veteranos:</label>
                <input type="file" id="tabela1" name="tabela1" accept=".csv" required>
                <label for="tabela2">Formulários dos bixos:</label>
                <input type="file" id="tabela2" name="tabela2" accept=".csv" required> <br>
                <input type="submit" value="Comparar">
            </form>
            <div id="resultados" style="padding: 0;"></div>
        </div>
        <div>
            <h2>COMO O CÓDIGO FUNCIONA:</h2>
            <p>O código foi feito de modo a realizar o seguinte passo a passo: <br>
                1. Ele recebe o input dos arquivos .csv, garante que ambos foram recebidos e processa suas informações
                pela função parseCSV <br>
                2. Em seguida, usa os valores atribuídos a cada resposta para calcular a distância euclidiana entre duas
                pessoas (isso ocorre com todas as pessoas, ou seja, ele calcula a distancia entre todas as duplas
                possíveis). <br>
                3. Então, pareia as duplas, começando pelas de menor distância (maior afinidade) para as de menor
                distância. <br>
                4. Exibe os resultados numa tabela e fornece um pdf com os pares e as pessoas não pareadas. <br>
            </p>
        </div>
    <main>
    <footer>
        <p> <br> <br> <br></p>
    </footer>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <script>

        // essa é a parte do código responsável por receber os inputs, conferindo se ambos os arquivos .csv foram enviados, e por envia´los à função parse
        document.getElementById('upload-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const tabela1 = document.getElementById('tabela1').files[0];
            const tabela2 = document.getElementById('tabela2').files[0];
            if (!tabela1 || !tabela2) {
                alert("Por favor, selecione ambos os arquivos .csv.");
                return;
            }
            Promise.all([parseCSV(tabela1), parseCSV(tabela2)])
                .then(([data1, data2]) => {
                    console.log(data1);
                    console.log(data2);
                    if (data1.length === 0 || data2.length === 0) {
                        alert("Um dos arquivos .csv está vazio ou não pôde ser lido.");
                        return;
                    }
                    // é a parte do código que confere se existem as colunas desejadas (no caso: nome e celular); se não houver pelo menos uma das duas, ele imprime uma mensagem de alerta
                    if (!data1[0].hasOwnProperty('Nome completo') || !data1[0].hasOwnProperty('Numero do celular sem caracter especial') ||
                        !data2[0].hasOwnProperty('Nome completo') || !data2[0].hasOwnProperty('Numero do celular sem caracter especial')) {
                        alert("Um dos arquivos .csv não contém as colunas 'Nome completo' e 'Numero do celular sem caracter especial'.");
                        return;
                    }
                    const resultados = compararTabelas(data1, data2);
                    exibirResultados(resultados);
                    salvarResultadosPDF(resultados, data1, data2);
                    if (resultados.length > 0) {
                        marcarNaoPareados(data1, data2, resultados);
                    }
                });
        });


        // essa é a função parse, que envia os aquivos .csv para uma biblioteca e analisa os seus dados
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    complete: results => resolve(results.data),
                    error: err => reject(err)
                });
            });
        }

        // essa é a função responsável pelo cálculo da distância euclidiana
        function calcularDistanciaEuclidiana(respostas1, respostas2) {
            let soma = 0;
            for (let i = 0; i < respostas1.length; i++) {
                let diferenca = parseInt(respostas1[i]) - parseInt(respostas2[i]);
                soma += diferenca * diferenca;
            }
            return Math.sqrt(soma);
        }

        // essa é a função responsável por extrair as respostas das pessoas; é ela quem ignora as colunas 'Carimbo de data/hora' e 'Nome completo' e 'Numero do celular'
        function extrairRespostasEscala(pessoa) {
            const respostas = Object.keys(pessoa)
                .filter(key => key !== 'Carimbo de data/hora' && key !== 'Nome completo' && key !== 'Numero do celular sem caracter especial')
                .map(key => pessoa[key]);
            console.log('Respostas extraídas:', respostas);
            return respostas;
        }

        // essa é a função que compara as tabelas, pegando cada indivíduo da tabela 1 (veteranos) e comparando com cada indivíduo da tabela 2 (bixos); é ela quem aciona as funções extrairRespostasEscala e calcularDistanciaEuclidiana
        function compararTabelas(tabela1, tabela2) {
            const resultados = [];
            // Iterar sobre cada pessoa na tabela1
            tabela1.forEach(pessoa1 => {
                if (!pessoa1['Pareado']) {
                    // Iterar sobre cada pessoa na tabela2
                    tabela2.forEach(pessoa2 => {
                        if (!pessoa2['Pareado']) {
                            const respostas1 = extrairRespostasEscala(pessoa1);
                            const respostas2 = extrairRespostasEscala(pessoa2);
                            const distancia = calcularDistanciaEuclidiana(respostas1, respostas2);
                            resultados.push({
                                pessoaTabela1: pessoa1,
                                pessoaTabela2: pessoa2,
                                distancia: distancia,
                            });
                        }
                    });
                }
            });

            // Ordenar os resultados pela menor distância
            resultados.sort((a, b) => a.distancia - b.distancia);

            // Selecionar os melhores resultados
            const melhoresResultados = [];
            const usadosTabela1 = new Set();
            const usadosTabela2 = new Set();

            for (const resultado of resultados) {
                const { pessoaTabela1, pessoaTabela2 } = resultado;
                const chaveTabela1 = `${pessoaTabela1['Nome completo']} (${pessoaTabela1['Numero do celular sem caracter especial']})`;
                const chaveTabela2 = `${pessoaTabela2['Nome completo']} (${pessoaTabela2['Numero do celular sem caracter especial']})`;

                if (!usadosTabela1.has(chaveTabela1) && !usadosTabela2.has(chaveTabela2)) {
                    melhoresResultados.push({
                        pessoaTabela1: chaveTabela1,
                        pessoaTabela2: chaveTabela2,
                        distancia: resultado.distancia,
                        horario1: new Date(pessoaTabela1['Carimbo de data/hora']),
                        horario2: new Date(pessoaTabela2['Carimbo de data/hora']),
                    });
                    usadosTabela1.add(chaveTabela1);
                    usadosTabela2.add(chaveTabela2);
                }
            }

            return melhoresResultados;
        }

        // essa é a função que exibe os resultados no site
        function exibirResultados(resultados) {
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.innerHTML = '';
            if (resultados.length === 0) {
                resultadosDiv.textContent = "Nenhum resultado encontrado.";
                return;
            }
            const tabela = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const cabecalho = ['Veteranos', 'Bixos', 'Distância'];
            const tr = document.createElement('tr');
            cabecalho.forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                tr.appendChild(th);
            });
            thead.appendChild(tr);
            tabela.appendChild(thead);
            resultados.forEach(resultado => {
                const tr = document.createElement('tr');
                ['pessoaTabela1', 'pessoaTabela2', 'distancia'].forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = resultado[key] || "0";
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            tabela.appendChild(tbody);
            resultadosDiv.appendChild(tabela);
        }


        // essa é a função que marca na tabelas do código quais pessoas não foram pareadas
        function marcarNaoPareados(tabela1, tabela2, resultados) {
            tabela1.forEach(pessoa => {
                if (!resultados.some(r => r.pessoaTabela1.includes(pessoa['Nome completo']) && r.pessoaTabela1.includes(pessoa['Numero do celular sem caracter especial']))) {
                    pessoa['Pareado'] = 'Nao';
                }
            });
            tabela2.forEach(pessoa => {
                if (!resultados.some(r => r.pessoaTabela2.includes(pessoa['Nome completo']) && r.pessoaTabela2.includes(pessoa['Numero do celular sem caracter especial']))) {
                    pessoa['Pareado'] = 'Nao';
                }
            });
        }

        // essa é a função que cria e baixa o pdf
        function salvarResultadosPDF(resultados, tabela1, tabela2) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const dadosTabela = resultados.map(resultado => [
                resultado.pessoaTabela1,
                resultado.pessoaTabela2,
                resultado.distancia.toFixed(2)
            ]);

            doc.autoTable({
                head: [['Veteranos', 'Bixos', 'Distância']],
                body: dadosTabela,
                styles: { fontSize: 10, cellPadding: 3 },
                headStyles: { fillColor: [76, 175, 80], textColor: [255, 255, 255], fontStyle: 'bold' },
                bodyStyles: { fillColor: [239, 239, 239], textColor: [0, 0, 0] },
                alternateRowStyles: { fillColor: [255, 255, 255] },
                margin: { top: 20 }
            });

            const naoPareadosTabela1 = tabela1.filter(p => !resultados.some(r => r.pessoaTabela1.includes(p['Nome completo']) && r.pessoaTabela1.includes(p['Numero do celular sem caracter especial']))).map(p => [`${p['Nome completo']} (${p['Numero do celular sem caracter especial']})`]);
            const naoPareadosTabela2 = tabela2.filter(p => !resultados.some(r => r.pessoaTabela2.includes(p['Nome completo']) && r.pessoaTabela2.includes(p['Numero do celular sem caracter especial']))).map(p => [`${p['Nome completo']} (${p['Numero do celular sem caracter especial']})`]);

            if (naoPareadosTabela1.length > 0 || naoPareadosTabela2.length > 0) {
                doc.autoTable({
                    head: [['Nome completo - Não Pareados']],
                    body: [...naoPareadosTabela1, ...naoPareadosTabela2],
                    startY: doc.autoTable.previous.finalY + 10,
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [231, 76, 60], textColor: [255, 255, 255], fontStyle: 'bold' },
                    bodyStyles: { fillColor: [245, 245, 245], textColor: [0, 0, 0] }
                });
            }

            doc.save('resultados_pareamento.pdf');
        }

    </script>

</body>

</html>